<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
      body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; }
      .container { max-width: 700px; margin-top: 30px; }
      .card-header { background: linear-gradient(45deg, #0d6efd, #0dcaf0); color: white; }
      .preview-img { max-width: 150px; max-height: 200px; margin-top: 15px; border-radius: 8px; border: 2px solid #ddd; display: none; object-fit: cover; }
      .form-select:disabled { background-color: #e9ecef; cursor: not-allowed; }
      .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
    </style>
  </head>
  <body>

    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
      <h5 class="mt-3 text-primary fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF...</h5>
      <p class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
    </div>

    <div class="container mb-5">
      <div class="card shadow">
        <div class="card-header text-center py-3">
          <h4 class="mb-0 fw-bold">ü™™ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô</h4>
          <small>‡∏á‡∏≤‡∏ô‡∏®‡∏¥‡∏•‡∏õ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏î‡∏≠‡∏¢‡∏™‡∏∞‡πÄ‡∏Å‡πá‡∏î)</small>
        </div>
        <div class="card-body p-4">

          <div id="dataStatus" class="alert alert-info text-center">
            <span class="spinner-border spinner-border-sm" role="status"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
            <select id="selSchool" class="form-select" onchange="onSelectSchool()" disabled><option value="">-- ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option></select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞/‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label>
            <select id="selSubject" class="form-select" onchange="onSelectSubject()" disabled><option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô --</option></select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</label>
            <select id="selActivity" class="form-select" onchange="onSelectActivity()" disabled><option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡πà‡∏≠‡∏ô --</option></select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">4. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏Ñ‡∏£‡∏π</label>
            <select id="selStudent" class="form-select text-primary fw-bold" onchange="onSelectStudent()" disabled><option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô --</option></select>
          </div>

          <hr class="my-4">

          <div class="mb-4 text-center">
            <label class="form-label fw-bold d-block">üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏π</label>
            
            <div id="existingImgAlert" class="alert alert-success py-1 px-2 d-inline-block small" style="display:none;">
              <i class="bi bi-check-circle-fill"></i> ‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ)
            </div>

            <input type="file" class="form-control mt-2" id="photoFile" accept="image/*" onchange="previewNewImage()">
            
            <br>
            <img id="imgPreview" class="preview-img shadow-sm" />
            
            <input type="hidden" id="existingImageUrl">
          </div>

          <div class="d-grid gap-2">
            <button id="btnSubmit" class="btn btn-primary btn-lg" onclick="submitForm()" disabled>
              <i class="bi bi-printer-fill"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß
            </button>
          </div>

          <div id="resultArea" class="mt-4 text-center" style="display:none;">
            <div class="alert alert-success">
              <h5 class="fw-bold">‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h5>
              <a id="downloadLink" href="#" target="_blank" class="btn btn-success mt-2 px-4">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</a>
            </div>
          </div>

        </div>
      </div>
    </div>

    <script>
      let allData = [];

      window.onload = function() {
        google.script.run.withSuccessHandler(function(response) {
          if (response.status === 'success') {
            let rawData = response.data;
            if (rawData.length > 1) {
              rawData.shift(); 
              allData = rawData; 
              initSchoolDropdown();
              document.getElementById('dataStatus').style.display = 'none';
            } else {
              showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á');
            }
          } else {
            showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + response.message);
          }
        }).getStudentList();
      };

      function showError(msg) {
        let statusDiv = document.getElementById('dataStatus');
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = '‚ùå ' + msg;
      }

      // --- Logic Cascading Dropdown ---
      function initSchoolDropdown() {
        const schools = [...new Set(allData.map(row => row[2]))].sort();
        populateSelect('selSchool', schools, '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
      }

      function onSelectSchool() {
        const selectedSchool = document.getElementById('selSchool').value;
        resetSelect('selSubject', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞'); resetSelect('selActivity', '‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞'); resetSelect('selStudent', '‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô');
        clearImagePreview(); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏π‡∏õ
        if (selectedSchool) {
          const filtered = allData.filter(row => row[2] === selectedSchool);
          const subjects = [...new Set(filtered.map(row => row[0]))].sort();
          populateSelect('selSubject', subjects, '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞');
        }
      }

      function onSelectSubject() {
        const selectedSchool = document.getElementById('selSchool').value;
        const selectedSubject = document.getElementById('selSubject').value;
        resetSelect('selActivity', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô'); resetSelect('selStudent', '‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô');
        clearImagePreview(); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏π‡∏õ
        if (selectedSubject) {
          const filtered = allData.filter(row => row[2] === selectedSchool && row[0] === selectedSubject);
          const activities = [...new Set(filtered.map(row => row[1]))].sort();
          populateSelect('selActivity', activities, '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô');
        }
      }

      function onSelectActivity() {
        const selectedSchool = document.getElementById('selSchool').value;
        const selectedSubject = document.getElementById('selSubject').value;
        const selectedActivity = document.getElementById('selActivity').value;
        resetSelect('selStudent', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π');
        clearImagePreview(); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏π‡∏õ
        if (selectedActivity) {
          const filtered = allData.filter(row => row[2] === selectedSchool && row[0] === selectedSubject && row[1] === selectedActivity);
          const students = filtered.map(row => row[3]);
          populateSelect('selStudent', students, '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π');
        }
      }

       // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Force Load (‡πÅ‡∏Å‡πâ‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô)
      function onSelectStudent() {
        const name = document.getElementById('selStudent').value;
        const school = document.getElementById('selSchool').value;
        const activity = document.getElementById('selActivity').value;
        const subject = document.getElementById('selSubject').value;

        clearImagePreview();

        if (name) {
          const foundRow = allData.find(row => row[2] === school && row[0] === subject && row[1] === activity && row[3] === name);
          
          if (foundRow) {
            const savedImageUrl = foundRow[5]; // Column F
            
            if (savedImageUrl && savedImageUrl.includes('http')) {
               // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô
               document.getElementById('existingImageUrl').value = savedImageUrl;
               document.getElementById('existingImgAlert').style.display = 'inline-block';
               document.getElementById('existingImgAlert').innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...';
               document.getElementById('btnSubmit').disabled = false;

               // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏°‡∏≤‡πÉ‡∏´‡πâ (Bypass Permission)
               google.script.run.withSuccessHandler(function(res) {
                 if (res.status === 'success') {
                   const imgPreview = document.getElementById('imgPreview');
                   imgPreview.src = res.data;
                   imgPreview.style.display = 'inline-block';
                   document.getElementById('existingImgAlert').innerHTML = '<i class="bi bi-check-circle-fill"></i> ‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
                 } else {
                   document.getElementById('existingImgAlert').innerHTML = '<i class="bi bi-exclamation-triangle"></i> ‡∏£‡∏π‡∏õ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏±‡∏õ‡πÉ‡∏´‡∏°‡πà)';
                   document.getElementById('existingImageUrl').value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏¥‡πâ‡∏á
                 }
               }).getImageBase64(savedImageUrl);
               
               return; 
            }
          }
        }
        document.getElementById('btnSubmit').disabled = true;
      }

      // --- Helper Functions ---
      function populateSelect(elementId, items, placeholder) {
        const select = document.getElementById(elementId);
        select.innerHTML = `<option value="">-- ${placeholder} --</option>`;
        items.forEach(item => { if(item) { let opt = document.createElement('option'); opt.value = item; opt.text = item; select.add(opt); } });
        select.disabled = false;
      }
      function resetSelect(elementId, placeholder) {
        const select = document.getElementById(elementId);
        select.innerHTML = `<option value="">-- ${placeholder} --</option>`;
        select.disabled = true;
      }
      function clearImagePreview() {
        document.getElementById('imgPreview').style.display = 'none';
        document.getElementById('imgPreview').src = "";
        document.getElementById('photoFile').value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        document.getElementById('existingImageUrl').value = "";
        document.getElementById('existingImgAlert').style.display = 'none';
        document.getElementById('btnSubmit').disabled = true;
      }

      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ user ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
      function previewNewImage() {
        const file = document.getElementById('photoFile').files[0];
        const preview = document.getElementById('imgPreview');
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'inline-block';
            document.getElementById('existingImgAlert').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß
            document.getElementById('existingImageUrl').value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤
            document.getElementById('btnSubmit').disabled = false;
          }
          reader.readAsDataURL(file);
        }
      }

      // --- Submit Form ---
      function submitForm() {
        const name = document.getElementById('selStudent').value;
        const school = document.getElementById('selSchool').value;
        const subject = document.getElementById('selSubject').value;
        const activity = document.getElementById('selActivity').value;
        const fileInput = document.getElementById('photoFile');
        const existingUrl = document.getElementById('existingImageUrl').value;

        // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ (‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤)
        if (!name || (!fileInput.files[0] && !existingUrl)) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
          return;
        }

        // ‡∏´‡∏≤ Venue (‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà)
        let venue = "";
        const foundRow = allData.find(row => row[2] === school && row[0] === subject && row[1] === activity && row[3] === name);
        if (foundRow) venue = foundRow[4];

        document.getElementById('loadingOverlay').style.display = 'flex';

        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå)
        if (!fileInput.files[0] && existingUrl) {
           runProcess({
             name: name, school: school, subject: subject, activity: activity, venue: venue,
             existingImageUrl: existingUrl // ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ
           });
           return;
        }

        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏±‡∏õ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
        const reader = new FileReader();
        reader.onload = function(e) {
          runProcess({
            name: name, school: school, subject: subject, activity: activity, venue: venue,
            imageFile: { data: e.target.result, type: fileInput.files[0].type }
          });
        };
        reader.readAsDataURL(fileInput.files[0]);
      }

      function runProcess(payload) {
        google.script.run.withSuccessHandler(function(res) {
            document.getElementById('loadingOverlay').style.display = 'none';
            if (res.status === 'success') {
              document.getElementById('resultArea').style.display = 'block';
              document.getElementById('downloadLink').href = res.url;
              document.getElementById('resultArea').scrollIntoView({behavior: "smooth"});
            } else {
              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + res.message);
            }
          }).processForm(payload);
      }
    </script>
  </body>
</html>
